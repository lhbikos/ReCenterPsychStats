```{r include = FALSE}
options(scipen=999)
```


## Homeworked Example
[Screencast Link](https://youtu.be/rLyN9GspdWU)

For more information about the data used in this homeworked example, please refer to the description and codebook located at the end of the [introduction](ReCintro).

### Working the Problem with R and R Packages

#### Narrate the research vignette, describing the IV and DV. The data you analyze should have at least 3 levels in the independent variable; at least one of the attempted problems should have a significant omnibus test so that follow-up is required) {-}

I want to ask the question, do course evaluation ratings for traditional pedagogy differ for students as we enacted a substantive revision to our statistics series.  The evaluative focus is on the ANOVA course and we will compare ratings from the stable, transition, and resettled stages of the transitional period. The variable (Stage) of interest will have three levels:  

* STABLE:  2017 represents the last year of "stability during the old way" when we taught with SPSS and during the 2nd year of the doctoral programs.
* TRANSITION:  2018 & 2019 represent the transition to R, when the classes were 30% larger because each of the IOP and CPY departments were transitioning to the 1st year (they did it separately, so as not to double the classes)
* RESETTLED:  2020 & 2021 represent the "resettled" phase where the transition to R was fairly complete and the class size returned to normal because the classes were offered in the first year.

This is not a variable that was included in the dataset posted to the OSF repository, so we will need to create it.

*If you wanted to use this example and dataset as a basis for a homework assignment, you could create a different subset of data. I worked the example for students taking the ANOVA class. You could choose multivariate or psychometrics. You could also choose a different dependent variable. I chose the traditional pedagogy subscale. Two other subscales include socially responsive pedagogy and valued by the student.*

#### Simulate (or import) and format data {-}  

```{r}
big <- readRDS("ReC.rds")
```

This df includes course evaluations from ANOVA, multivariate, and psychometrics. To include up to three evaluations per student would violate the assumption of independence, therefore, I will only select the students in ANOVA course.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
big <- subset(big, Course == "ANOVA") 
```

Let's first create the "Stage" variable that represents the three levels of transition.

The ProgramYear variable contains the information I need, but the factor labels are not intuitive. Let me remap them.
```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
big$Stage <- plyr::mapvalues(big$ProgramYear, from = c("Second", "Transition", "First"), to = c("Stable", "Transition", "Resettled"))
```

Let's check the structure:

```{r}
str(big$Stage)
```

The TradPed (traditional pedagogy) variable is an average of the items on that scale. I will first create that variable.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
#Creates a list of the variables that belong to that scale
TradPed_vars <- c('ClearResponsibilities', 'EffectiveAnswers','Feedback', 'ClearOrganization','ClearPresentation')

#Calculates a mean if at least 75% of the items are non-missing; adjusts the calculating when there is missingness
#big$TradPed <- sjstats::mean_n(big[, ..TradPed_vars], .75)
big$TradPed <- sjstats::mean_n(big[, TradPed_vars], .75)
```

With our variables properly formatted, let's trim it to just the variables we need.
```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
OneWay_df <-(dplyr::select (big, Stage, TradPed))
```

Although we would handle missing data more carefully in a "real study," I will delete all cases with any missingness. This will prevent problems in the hand-calculations section, later (and keep the two sets of results more similar).

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
OneWay_df <- na.omit(OneWay_df)
```

Although the assignment doesn't require it, I will make a quick plot to provide a visualizaiton of our analysis.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
ggpubr::ggboxplot(OneWay_df, x = "Stage", y = "TradPed", add = "jitter",
    color = "Stage", title = "Figure 1. Evaluations of Traditional Pedagogy as a Result of Transition") #
```


#### Evaluate statistical assumptions {-} 

**Is the dependent variable normally distributed across levels of the factor?**

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
psych::describeBy(TradPed ~ Stage, mat = TRUE, digits = 3, data = OneWay_df, type = 1)
```

We'll use Kline's (2016) threshholds of the absolute values of 3 (skew) and 10 (kurtosis). The highest absolute value of skew is -0.881; the highest absolute value of kurtosis is -0.629. These are well below the areas of concern.

the Shapiro-wilk test is a formal assessment of normality. It is a 2-part test that begins with creating an ANOVA model from which we can extract residuals, then testing the residuals.  

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
TradPed_res <- lm(TradPed ~ Stage, data = OneWay_df)
#TradPed_res
rstatix::shapiro_test(residuals(TradPed_res))
```
The Shapiro-Wilk test suggests that the our distribution of residuals is statistically significantly different from a normal distribution $(W = 0.941, p < .001)$.

It is possible to plot the residuals to see how and where they deviate from the line.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
ggpubr::ggqqplot(residuals(TradPed_res))
```
Ooof!  at the ends of the distribution they really deviate. 

**Should we remove outliers?**

The *rstatix::identify_outliers()* function identifies outliers and extreme outliers.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
library(tidyverse)
OneWay_df %>%
  rstatix::identify_outliers(TradPed)
```

There are 4 cases identified with outliers; none of those is extreme. I also notice that these outliers are low course evaluations. It seems only fair to retain the data from individuals who were not satisfied with the course.

**Are the variances of the dependent variable similar across the levels of the grouping factor?**

We want the results of the Levene's homogeneity of variance test to be non-significant. This would support the notion that the TradPed variance is equivalent across the three stages of the transition.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
rstatix::levene_test(OneWay_df, TradPed ~ Stage)
```
The non-significant *p* value suggests that the variances across the three stages are not statistically significantly different:  $F(2, 109) = 4.523, p = 0.013$.


Before moving on, I will capture our findings in an APA style write-up of the testing of assumptions:

>Regarding the assumption of normality, skew and kurtosis values at each of the levels of program year fell well below the thresholds that Kline (2016a) identified as concerning (i.e., below |3| for skew and |10| for kurtosis). In contrast, results of a model-based Shapiro-Wilk test of normality, indicated that the model residuals differed from a normal distribution $(W = 0.941, p < .001)$. Although 4 outliers were identified none were extreme, thus we retained all cases. Finally, Levene’s homogeneity of variance test indicated a violation of the homogeneity of variance assumption $F(2, 109) = 4.523, p = 0.013$. ANOVA is relatively robust to this violation when there are at least 15 cases per cell and the design is balanced (i.e., equivalent cell sizes). While we have at least 15 cases per cell, we have a rather unbalanced design. We will need to keep this limitation in mind as we interpret the results.

#### Conduct omnibus ANOVA (w effect size) {-} 

The *rstatix::anova_test()* function calculates the one-way ANOVA and includes the effect size, $\eta^2$ in the column, *ges*. 

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
omnibus1w <- rstatix::anova_test(OneWay_df, TradPed ~ Stage, detailed = FALSE)
omnibus1w
```
The one-way ANOVA is statistically significant. This means that there should be at least one statistically significant difference between levels of the design. Before moving on, I will capture the *F* string:  $F(2, 109) = 7.199, p = 0.001, \eta^2 = 0.117$. Regarding the effect size, values of .01, .07, and .14 are considered to be small, medium, and large. The value of .11 would be medium-to-large.

#### Conduct one set of follow-up tests; narrate your choice {-}

I will simply calculate post-hoc comparisons. That is, all possible pairwise comparisons. I will specify the traditional Bonferroni as the approach to managing Type I error.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
phoc <- rstatix::t_test(OneWay_df, TradPed ~ Stage, p.adjust.method = "bonferroni", detailed = TRUE)
phoc
```

The post hoc tests suggested statistically significant differences between the stable transition resettled stages, favoring the stable period of time (i.e., using SPSS and taught in the second year).

#### Describe approach for managing Type I error {-} 

We used the Bonferroni. The Bonferroni divides the overall alpha (.05) by the number of comparisons (3). In this case, a *p* value woul dhave to be lower than 0.017 to be statistically significant. The calulation reverse-engineers this so that we can interpret the *p* values by the traditional. 0.05. In the output, it is possible to see the higher threshholds necessary to claim statistical significance.

#### APA style results with table(s) and figure {-}  

>A one-way analysis of variance was conducted to evaluate the effects of significant transitions (e.g., from SPSS to R; to the second to the first year in a doctoral program) on students ratings of traditional pedagogy. The independent variable, stage, included three levels: stable (with SPSS and taught in the second year of a doctoral program), transitioning (with R and students moving from second to first year), and resettled (with R and in the first year of the program).

>Regarding the assumption of normality, skew and kurtosis values at each of the levels of program year fell well below the thresholds that Kline (2016a) identified as concerning (i.e., below |3| for skew and |10| for kurtosis). In contrast, results of a model-based Shapiro-Wilk test of normality, indicated that the model residuals differed from a normal distribution $(W = 0.941, p < .001)$. Although 4 outliers were identified none were extreme, thus we retained all cases. Finally, Levene’s homogeneity of variance test indicated a violation of the homogeneity of variance assumption $F(2, 109) = 4.523, p = 0.013$. ANOVA is relatively robust to this violation when there are at least 15 cases per cell and the design is balanced (i.e., equivalent cell sizes). While we have at least 15 cases per cell, we have a rather unbalanced design. We will need to keep this limitation in mind as we interpret the results.

>Results of the omnibus ANOVA indicated a statistically significant effect of stage on students assessments of traditional pedagogy, $F(2, 109) = 7.199, p = 0.001, \eta^2 = 0.117$. The effect size was medium-to-large. We followed up the significant omnibus with all possible pairwise comparisons. We controlled for Type I error with the traditional Bonferroni adjustment. Results suggested that there were statistically significant differences between the stable and transition stages $(Mdiff = 0.655, p = 0.003)$, but not between stable and resettled $(Mdiff = 0.267,p = 0.324)$ or transition and resettled $(Mdiff= -0.388,p = 0.217)$ stages. Given that the doctoral programs are unlikely to transition back to SPSS or into the second year, the instructor(s) are advised to consider ways that could result in greater student satisfaction. Means and standard deviations are presented in Table 1 and complete ANOVA results are presented in Table 2. Figure 1 provides an illustration of the results.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
apaTables::apa.1way.table(iv = Stage, dv = TradPed, show.conf.interval = TRUE, data = OneWay_df, table.number = 1, filename = "1wayHWTable.doc")
```

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
omnibus1wHW_b <- aov(TradPed ~ Stage, data = OneWay_df)
apaTables::apa.aov.table(omnibus1wHW_b, table.number = 2, filename = "1wayHWTable2.doc")
```

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
phoc <- phoc %>%
    rstatix::add_xy_position(x = "Stage")

ggpubr::ggboxplot(OneWay_df, x = "Stage", y = "TradPed", add = "jitter",
    color = "Stage", title = "Figure 1. Evaluations of Traditional Pedagogy as a Result of Transition") +
    ggpubr::stat_pvalue_manual(phoc, label = "p.adj.signif", tip.length = 0.02,
        hide.ns = TRUE, y.position = c(5.5))
```

#### Conduct power analyses to determine the power of the current study and a recommended sample size {-}

The *pwr.anova.test()* has five parameters:

* *k* = # groups
* *n* = sample size per group
* *f* = effect sizes, where 0.1/small, 0.25/medium, and 0.4/large
  - In the absence from an estimate from our own data, we make a guess about the expected effect size value based on our knowledge of the literature
* *sig.level* = *p* value that you will use
* *power* = .80 is the standard value

In the script below, we simply add our values. So long as we have four values, the fifth will be calculated for us.

Because this calculator requires the effect size in the metric of Cohen's *f* (this is not the same as the *F* ratio), we need to convert it. The *effectsize* package has a series of converters. We can use the *eta2_to_f()* function. 

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
effectsize::eta2_to_f(.117) 
```
We simply plug this value into the "f =".

First let's ask what our level of power was?  Our goal would be 80%.

Given that our design was unbalanced (21, 44, 47 across the three stages), I used 38 (114/3).

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
pwr::pwr.anova.test (k = 3, f = .3640094, sig.level = .05, n = 38)
```
Our power was 0.94. That is, we had 94% chance to find a statistically significant result if one existed. In the next power analysis, let's see what sample size is recommended.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
pwr::pwr.anova.test (k = 3, f = .3640094, sig.level = .05, power = .80)
```
In order to be at 80% power to find a statistically significant result if there is one, we would need only 25 people per group. We currently had an unbalanced design of 50, 41, 21.

### Hand Calculations

Before we continue: 

>You may notice that the results from the hand calculation are slightly different from the results I will obtain with the R packages. This is because the formula we have used for the hand-calculations utilizes an  approach to calculating the sums of squares that presumes that we have a balanced design (i.e., that the cell sizes are equal). When cell sizes are unequal (i.e., an unbalanced design) the Type II package in *rstatix::anova_test* may produce different result.

> Should we be concerned? No (and yes). My purpose in teaching hand calculations is for creating a conceptual overview of what is occurring in ANOVA models. If this lesson was a deeper exploration into the inner workings of ANOVA, we would take more time to understand what is occurring. My goal is to provide you with enough of an introduction to ANOVA that you would be able to explore further which sums of squares type would be most appropriate for your unique ANOVA model.

#### Using traditional NHST (null hypothesis testing language), state your null and alternative hypotheses {-}

Regarding the evaluation of traditional pedgagoy across three stages of transitions to a doctoral ANOVA course, the null hypothesis predicts no differences between the three levels of the dependent variable:

$$H_{O}: \mu _{1} = \mu _{2} = \mu _{3}$$

In contrast, the alternative hypothesis suggests there will be differences. Apriorily, I did not make any specific predictions.

$$H_{a1}: \mu _{1} \neq \mu _{2} \neq \mu _{3}$$

#### Calculate sums of squares total (SST). Steps in this calculation must include calculating a grand mean and creating variables representing the mean deviation and mean deviation squared {-}

I will use this approach to calculating sums of squares total:

$$SS_{T}= \sum (x_{i}-\bar{x}_{grand})^{2}$$

I will use the *psych::describe()* function to obtain the overall mean:

```{r}
psych::describe(OneWay_df)
```

Next, I will subtract this value from each person's TradPed value. This will create a mean deviation.


```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
OneWay_df$mdevTP <- OneWay_df$TradPed - 4.06
#I could also calculate it by using the "mean" function
#I had to include an na.rm=TRUE; this appears to be connected to missingness
OneWay_df$mdevTPb <- OneWay_df$TradPed - mean(OneWay_df$TradPed, na.rm=TRUE)
head(OneWay_df)
```

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
library(tidyverse)
OneWay_df <- OneWay_df %>% 
  dplyr::mutate(m_devSQTP = mdevTP^2)

#so we can see this in the textbook
head(OneWay_df)
```

I will ask for a sum of the mean deviation squared column. The function was not running, sometimes this occurs when there is missing data. While I didn't think that was true, adding "na.rm = TRUE" solved the problem.
```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
SST <- sum(OneWay_df$m_devSQTP, na.rm = TRUE)
SST
```
SST = 83.0332

#### Calculate the sums of squares for the model (SSM). A necessary step in this equation is to calculate group means {-} 

The formula for SSM is $$SS_{M}= \sum n_{k}(\bar{x}_{k}-\bar{x}_{grand})^{2}$$

We will need:

* *n* for each group,
* Grand mean (earlier we learned it was 4.06),
* Group means

We can obtain the group means several ways. I think the *psych::describeBy()* function is one of the easiest.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
psych::describeBy(TradPed ~ Stage, mat = TRUE, digits = 3, data = OneWay_df, type = 1)
```

Now we can pop these values into the formula.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
SSM <- 50 * (4.348 -4.06)^2 + 41 * (3.693 - 4.06)^2 + 21 * (4.081 - 4.06)^2
SSM
```
SSM = 9.67871


#### Calculate the sums of squares residual (SSR). A necessary step in this equation is to calculate the variance for each group {-} 

The formula for I will use to calculate SSR is $$SS_{R}= s_{group1}^{2}(n-1) + s_{group2}^{2}(n-1) + s_{group3}^{2}(n-1))$$

We will need:

* *n* for each group,
* variance (standard deviation, squared) for each group

We can obtain these values from the previous run of the *psych::describeBy()* function.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
SSR <- (0.658^2)*(50 - 1) + (1.057^2)*(41 - 1) + (0.610^2)*(21-1)
SSR
```
SSR = 73.3472


#### Calculate the mean square model, mean square residual, and *F*-test {-} 

The formula for mean square model is $$MS_M = \frac{SS_{M}}{df{_{M}}}$$

* $SS_M$ was 9.67871
* $df_M$ is *k* - 1 (where *k* is number of groups/levels)

```{r}
MSM <- 9.67871/2
MSM
```
MSM is 4.839

The formula for mean square residual is $$MS_R = \frac{SS_{R}}{df{_{R}}}$$

* $SS_R$ was 79.292
* $df_R$ is $N - k$ (112 - 3 = 109)

```{r}
MSR = 73.3472/109
MSR
```

The formula for the *F* ratio is $$F = \frac{MS_{M}}{MS_{R}}$$

```{r}
F <- 4.839/0.6729101
F
```
*F* = 7.191154


#### What are the degrees of freedom for your numerator and denominator? {-}

Numerator or $df_M$:  2
Denominator or $df_R$:  109

#### Locate the test critical value for your one-way ANOVA {-}  

We could use use a [table of critical values](https://www.statology.org/how-to-read-the-f-distribution-table/) for the *F* distribution.

The closest *N* in the table I am using is 120. If we set alpha at 0.05, our test value would need to exceed the absolute value of 3.0718.

We can also use a look-up function, which follows this general form: qf(p, df1, df2. lower.tail=FALSE)
```{r tidy=TRUE, tidy.opts=list(width.cutoff=70)}
qf(.05, 2, 109, lower.tail=FALSE)
```
Not surprisingly the values are quite similar.

#### Is the *F*-test statistically significant? Why or why not? {-}

Because the value of the *F* test (7.191) exceeded the absolute value of the critical value (3.080), the *F* test is statistically significant.

#### Calculate and interpret the $\eta^2$ effect size {-}

The formula to calculate the effect size is $$\eta ^{2}=\frac{SS_{M}}{SS_{T}}$$

* $SS_M$ was 9.679
* $SS_T$ was 83.0332

```{r}
etaSQ <- 9.679/83.0332
etaSQ
```
Eta square is 0.117. Values of .01, .06, and .14 are interpreted as small, medium, and large. Our value of 0.12 is medium-to-large.


#### Assemble the results into a statistical string {-} 

$$F(2, 109) = 7.191, p < .05, \eta^2 = 0.117$$